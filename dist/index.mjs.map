{"version":3,"sources":["../lib/server.ts","../lib/types.ts","../lib/storage.ts","../lib/utils.ts","../lib/chain.ts"],"sourcesContent":["import express, { Express, Request, Response, NextFunction } from 'express';\nimport cors from 'cors';\nimport helmet from 'helmet';\nimport type {\n  PaylinkConfig,\n  PayLink,\n  Payment,\n  CreatePayLinkInput,\n  Protocol402Response,\n  Protocol403Response,\n  Storage,\n} from './types.js';\nimport { ReasonCode } from './types.js';\nimport { MemoryStorage } from './storage.js';\nimport { ChainVerifier, MockVerifier } from './chain.js';\nimport {\n  generateId,\n  generateUUID,\n  generateNonce,\n  sign,\n  isExpired,\n  isLimitReached,\n  REASON_MESSAGES,\n} from './utils.js';\n\n/**\n * Paylink Server\n * Self-hosted paid links with blockchain payment verification\n */\nexport class PaylinkServer {\n  private app: Express;\n  private config: Required<Omit<PaylinkConfig, 'chains'>> & { chains: PaylinkConfig['chains'] };\n  private storage: Storage;\n  private verifiers: Map<number, ChainVerifier | MockVerifier>;\n\n  constructor(config: PaylinkConfig) {\n    // Default config\n    this.config = {\n      port: config.port ?? 3000,\n      baseUrl: config.baseUrl ?? '',\n      basePath: config.basePath ?? '/pay',\n      chains: config.chains,\n      paymentTimeout: config.paymentTimeout ?? 900,\n      signatureSecret: config.signatureSecret ?? '',\n      apiKey: config.apiKey ?? '',\n      cors: config.cors ?? true,\n    };\n\n    this.storage = new MemoryStorage();\n    this.verifiers = new Map();\n\n    // Initialize chain verifiers\n    for (const chain of config.chains) {\n      if (chain.rpcUrl === 'mock') {\n        this.verifiers.set(chain.chainId, new MockVerifier());\n      } else {\n        this.verifiers.set(chain.chainId, new ChainVerifier(chain));\n      }\n    }\n\n    this.app = express();\n    this.setupMiddleware();\n    this.setupRoutes();\n  }\n\n  /**\n   * Get Express app instance\n   */\n  getApp(): Express {\n    return this.app;\n  }\n\n  /**\n   * Get storage instance\n   */\n  getStorage(): Storage {\n    return this.storage;\n  }\n\n  /**\n   * Set custom storage\n   */\n  setStorage(storage: Storage): void {\n    this.storage = storage;\n  }\n\n  /**\n   * Start server\n   */\n  start(): void {\n    this.app.listen(this.config.port, () => {\n      console.log('');\n      console.log('╔══════════════════════════════════════════════════════════╗');\n      console.log('║              Paylink Protocol Server                     ║');\n      console.log('╠══════════════════════════════════════════════════════════╣');\n      console.log(`║  Port:     ${String(this.config.port).padEnd(44)}║`);\n      console.log(`║  Base URL: ${(this.config.baseUrl || 'http://localhost:' + this.config.port).padEnd(44)}║`);\n      console.log(`║  Chains:   ${this.config.chains.map(c => c.name).join(', ').padEnd(44)}║`);\n      console.log('╚══════════════════════════════════════════════════════════╝');\n      console.log('');\n      console.log('Endpoints:');\n      console.log(`  GET  ${this.config.basePath}/:id          → Payment page (402/403/302)`);\n      console.log(`  GET  ${this.config.basePath}/:id/status   → Check payment status`);\n      console.log(`  POST ${this.config.basePath}/:id/confirm  → Confirm with txHash`);\n      console.log('');\n      if (this.config.apiKey) {\n        console.log('Admin API (X-API-Key header required):');\n        console.log('  POST   /api/links       → Create link');\n        console.log('  GET    /api/links       → List links');\n        console.log('  GET    /api/links/:id   → Get link');\n        console.log('  DELETE /api/links/:id   → Disable link');\n        console.log('  GET    /api/payments    → List payments');\n        console.log('');\n      }\n    });\n  }\n\n  // ========================================\n  // PAYLINK METHODS\n  // ========================================\n\n  /**\n   * Create a new payment link\n   */\n  async createPayLink(input: CreatePayLinkInput): Promise<PayLink> {\n    const now = new Date();\n    \n    const payLink: PayLink = {\n      id: generateId(),\n      targetUrl: input.targetUrl,\n      price: input.price,\n      recipientAddress: input.recipientAddress,\n      status: 'active',\n      createdAt: now,\n      updatedAt: now,\n      description: input.description,\n      maxUses: input.maxUses,\n      usedCount: 0,\n      expiresAt: input.expiresAt,\n      metadata: input.metadata,\n    };\n\n    await this.storage.savePayLink(payLink);\n    return payLink;\n  }\n\n  /**\n   * Get payment link by ID\n   */\n  async getPayLink(id: string): Promise<PayLink | null> {\n    return this.storage.getPayLink(id);\n  }\n\n  /**\n   * Disable a payment link\n   */\n  async disablePayLink(id: string): Promise<void> {\n    const link = await this.storage.getPayLink(id);\n    if (!link) throw new Error('Link not found');\n    \n    link.status = 'disabled';\n    await this.storage.updatePayLink(link);\n  }\n\n  // ========================================\n  // PRIVATE METHODS\n  // ========================================\n\n  private setupMiddleware(): void {\n    this.app.use(helmet());\n    \n    if (this.config.cors) {\n      this.app.use(cors({ origin: '*', methods: ['GET', 'POST', 'DELETE'] }));\n    }\n    \n    this.app.use(express.json());\n    this.app.set('trust proxy', 1);\n\n    // Request logging\n    this.app.use((req, res, next) => {\n      const start = Date.now();\n      res.on('finish', () => {\n        console.log(`${req.method} ${req.path} ${res.statusCode} ${Date.now() - start}ms`);\n      });\n      next();\n    });\n  }\n\n  private setupRoutes(): void {\n    // Health check\n    this.app.get('/health', (req, res) => {\n      res.json({ status: 'ok', timestamp: new Date().toISOString() });\n    });\n\n    // API info\n    this.app.get('/', (req, res) => {\n      const base = this.config.baseUrl || `http://localhost:${this.config.port}`;\n      res.json({\n        name: 'Paylink Protocol',\n        version: '1.0.0',\n        chains: this.config.chains.map(c => ({ id: c.chainId, name: c.name, symbol: c.symbol })),\n        endpoints: {\n          paylink: `${base}${this.config.basePath}/:id`,\n          status: `${base}${this.config.basePath}/:id/status`,\n          confirm: `${base}${this.config.basePath}/:id/confirm`,\n        },\n      });\n    });\n\n    // Paylink routes\n    this.app.get(`${this.config.basePath}/:id`, this.handlePayLink.bind(this));\n    this.app.get(`${this.config.basePath}/:id/status`, this.handleStatus.bind(this));\n    this.app.post(`${this.config.basePath}/:id/confirm`, this.handleConfirm.bind(this));\n\n    // Admin API\n    if (this.config.apiKey) {\n      const auth = this.authMiddleware.bind(this);\n      this.app.post('/api/links', auth, this.apiCreateLink.bind(this));\n      this.app.get('/api/links', auth, this.apiListLinks.bind(this));\n      this.app.get('/api/links/:id', auth, this.apiGetLink.bind(this));\n      this.app.delete('/api/links/:id', auth, this.apiDeleteLink.bind(this));\n      this.app.get('/api/payments', auth, this.apiListPayments.bind(this));\n    }\n  }\n\n  private authMiddleware(req: Request, res: Response, next: NextFunction): void {\n    const key = req.headers['x-api-key'];\n    if (key !== this.config.apiKey) {\n      res.status(401).json({ error: 'Invalid API key' });\n      return;\n    }\n    next();\n  }\n\n  // ========================================\n  // PAYLINK HANDLERS\n  // ========================================\n\n  private async handlePayLink(req: Request, res: Response): Promise<void> {\n    try {\n      const link = await this.storage.getPayLink(req.params.id);\n\n      if (!link) {\n        res.status(404).json({ error: 'Payment link not found' });\n        return;\n      }\n\n      // Check if disabled\n      if (link.status !== 'active') {\n        this.send403(res, ReasonCode.LINK_DISABLED, link.id);\n        return;\n      }\n\n      // Check if expired\n      if (isExpired(link.expiresAt)) {\n        this.send403(res, ReasonCode.LINK_EXPIRED, link.id, {\n          expiredAt: link.expiresAt?.toISOString(),\n        });\n        return;\n      }\n\n      // Check usage limit\n      if (isLimitReached(link.usedCount, link.maxUses)) {\n        this.send403(res, ReasonCode.LINK_USAGE_LIMIT_REACHED, link.id, {\n          maxUses: link.maxUses,\n          usedCount: link.usedCount,\n        });\n        return;\n      }\n\n      // Check for confirmed payment\n      const payment = await this.storage.getConfirmedPayment(link.id);\n\n      if (payment) {\n        // Increment usage and redirect\n        link.usedCount = (link.usedCount ?? 0) + 1;\n        await this.storage.updatePayLink(link);\n        res.redirect(302, link.targetUrl);\n        return;\n      }\n\n      // No payment - return 402\n      this.send402(res, link);\n    } catch (error) {\n      console.error('PayLink error:', error);\n      res.status(500).json({ error: 'Internal server error' });\n    }\n  }\n\n  private async handleStatus(req: Request, res: Response): Promise<void> {\n    try {\n      const link = await this.storage.getPayLink(req.params.id);\n\n      if (!link) {\n        res.json({ status: 'not_found' });\n        return;\n      }\n\n      if (link.status !== 'active') {\n        res.json({ status: 'forbidden' });\n        return;\n      }\n\n      if (isExpired(link.expiresAt) || isLimitReached(link.usedCount, link.maxUses)) {\n        res.json({ status: 'forbidden' });\n        return;\n      }\n\n      const payment = await this.storage.getConfirmedPayment(link.id);\n      res.json({ status: payment ? 'paid' : 'unpaid' });\n    } catch (error) {\n      console.error('Status error:', error);\n      res.status(500).json({ error: 'Internal server error' });\n    }\n  }\n\n  private async handleConfirm(req: Request, res: Response): Promise<void> {\n    try {\n      const { txHash } = req.body;\n\n      if (!txHash || typeof txHash !== 'string') {\n        res.status(400).json({ status: 'failed', message: 'Missing txHash' });\n        return;\n      }\n\n      const link = await this.storage.getPayLink(req.params.id);\n\n      if (!link) {\n        res.status(404).json({ status: 'failed', message: 'Link not found' });\n        return;\n      }\n\n      // Check if already confirmed\n      const existing = await this.storage.getPaymentByTxHash(txHash);\n      if (existing?.confirmed) {\n        res.json({ status: 'confirmed', message: 'Already confirmed' });\n        return;\n      }\n\n      // Get verifier for chain\n      const verifier = this.verifiers.get(link.price.chainId);\n      if (!verifier) {\n        res.status(400).json({ status: 'failed', message: 'Chain not supported' });\n        return;\n      }\n\n      // Verify payment\n      const result = await verifier.verifyPayment({\n        txHash,\n        recipient: link.recipientAddress,\n        amount: link.price.amount,\n      });\n\n      switch (result.status) {\n        case 'confirmed': {\n          const payment: Payment = {\n            id: generateUUID(),\n            payLinkId: link.id,\n            chainId: link.price.chainId,\n            txHash,\n            fromAddress: result.fromAddress ?? '',\n            amount: result.actualAmount ?? link.price.amount,\n            confirmed: true,\n            createdAt: new Date(),\n            confirmedAt: new Date(),\n          };\n          await this.storage.savePayment(payment);\n          res.json({ status: 'confirmed' });\n          break;\n        }\n        case 'pending':\n          res.status(202).json({ status: 'pending', message: 'Transaction pending' });\n          break;\n        case 'underpaid':\n          res.status(400).json({\n            status: 'failed',\n            message: `Underpaid: received ${result.actualAmount}, required ${link.price.amount}`,\n          });\n          break;\n        default:\n          res.status(400).json({ status: 'failed', message: 'Transaction not found or failed' });\n      }\n    } catch (error) {\n      console.error('Confirm error:', error);\n      res.status(500).json({ error: 'Internal server error' });\n    }\n  }\n\n  // ========================================\n  // ADMIN API HANDLERS\n  // ========================================\n\n  private async apiCreateLink(req: Request, res: Response): Promise<void> {\n    try {\n      const {\n        targetUrl,\n        amount,\n        tokenSymbol = 'ETH',\n        chainId = 1,\n        recipientAddress,\n        description,\n        maxUses,\n        expiresIn,\n      } = req.body;\n\n      if (!targetUrl || !amount || !recipientAddress) {\n        res.status(400).json({ error: 'Missing: targetUrl, amount, or recipientAddress' });\n        return;\n      }\n\n      const link = await this.createPayLink({\n        targetUrl,\n        price: { amount: String(amount), tokenSymbol, chainId: Number(chainId) },\n        recipientAddress,\n        description,\n        maxUses: maxUses ? Number(maxUses) : undefined,\n        expiresAt: expiresIn ? new Date(Date.now() + Number(expiresIn) * 1000) : undefined,\n      });\n\n      const base = this.config.baseUrl || `http://localhost:${this.config.port}`;\n\n      res.status(201).json({\n        success: true,\n        link: {\n          id: link.id,\n          url: `${base}${this.config.basePath}/${link.id}`,\n          targetUrl: link.targetUrl,\n          price: link.price,\n          recipientAddress: link.recipientAddress,\n          description: link.description,\n          maxUses: link.maxUses,\n          expiresAt: link.expiresAt?.toISOString(),\n        },\n      });\n    } catch (error) {\n      console.error('Create link error:', error);\n      res.status(500).json({ error: 'Internal server error' });\n    }\n  }\n\n  private async apiListLinks(req: Request, res: Response): Promise<void> {\n    const links = await this.storage.getAllPayLinks();\n    const base = this.config.baseUrl || `http://localhost:${this.config.port}`;\n\n    res.json({\n      count: links.length,\n      links: links.map(l => ({\n        id: l.id,\n        url: `${base}${this.config.basePath}/${l.id}`,\n        status: l.status,\n        price: l.price,\n        usedCount: l.usedCount,\n      })),\n    });\n  }\n\n  private async apiGetLink(req: Request, res: Response): Promise<void> {\n    const link = await this.storage.getPayLink(req.params.id);\n\n    if (!link) {\n      res.status(404).json({ error: 'Link not found' });\n      return;\n    }\n\n    const base = this.config.baseUrl || `http://localhost:${this.config.port}`;\n\n    res.json({\n      id: link.id,\n      url: `${base}${this.config.basePath}/${link.id}`,\n      targetUrl: link.targetUrl,\n      price: link.price,\n      recipientAddress: link.recipientAddress,\n      status: link.status,\n      usedCount: link.usedCount,\n      maxUses: link.maxUses,\n      expiresAt: link.expiresAt?.toISOString(),\n      createdAt: link.createdAt.toISOString(),\n    });\n  }\n\n  private async apiDeleteLink(req: Request, res: Response): Promise<void> {\n    try {\n      await this.disablePayLink(req.params.id);\n      res.json({ success: true });\n    } catch {\n      res.status(404).json({ error: 'Link not found' });\n    }\n  }\n\n  private async apiListPayments(req: Request, res: Response): Promise<void> {\n    const payments = await this.storage.getAllPayments();\n\n    res.json({\n      count: payments.length,\n      payments: payments.map(p => ({\n        id: p.id,\n        payLinkId: p.payLinkId,\n        txHash: p.txHash,\n        amount: p.amount,\n        confirmed: p.confirmed,\n        createdAt: p.createdAt.toISOString(),\n      })),\n    });\n  }\n\n  // ========================================\n  // RESPONSE HELPERS\n  // ========================================\n\n  private send402(res: Response, link: PayLink): void {\n    const base = this.config.baseUrl || `http://localhost:${this.config.port}`;\n    const nonce = generateNonce();\n\n    const body: Protocol402Response = {\n      protocol: '402-paylink-v1',\n      payLinkId: link.id,\n      resource: {\n        description: link.description,\n        preview: null,\n      },\n      payment: {\n        chainId: link.price.chainId,\n        tokenSymbol: link.price.tokenSymbol,\n        amount: link.price.amount,\n        recipient: link.recipientAddress,\n        timeoutSeconds: this.config.paymentTimeout,\n      },\n      callbacks: {\n        status: `${base}${this.config.basePath}/${link.id}/status`,\n        confirm: `${base}${this.config.basePath}/${link.id}/confirm`,\n      },\n      nonce,\n    };\n\n    if (this.config.signatureSecret) {\n      const data = JSON.stringify({ payLinkId: body.payLinkId, payment: body.payment, nonce });\n      body.signature = sign(data, this.config.signatureSecret);\n    }\n\n    res.set({\n      'Content-Type': 'application/json; charset=utf-8',\n      'X-Paylink-Protocol': '402-v1',\n    });\n    res.status(402).json(body);\n  }\n\n  private send403(\n    res: Response,\n    code: ReasonCode,\n    payLinkId?: string,\n    details?: Record<string, unknown>\n  ): void {\n    const body: Protocol403Response = {\n      protocol: '403-paylink-v1',\n      payLinkId,\n      reasonCode: code,\n      reasonMessage: REASON_MESSAGES[code] ?? 'Forbidden',\n      details,\n    };\n\n    res.set({\n      'Content-Type': 'application/json; charset=utf-8',\n      'X-Paylink-Protocol': '403-v1',\n    });\n    res.status(403).json(body);\n  }\n}\n\n/**\n * Create and start a paylink server\n */\nexport function createServer(config: PaylinkConfig): PaylinkServer {\n  return new PaylinkServer(config);\n}\n","/**\n * Payment link status\n */\nexport type PayLinkStatus = 'active' | 'disabled' | 'expired';\n\n/**\n * Payment verification status\n */\nexport type PaymentStatus = 'not_found' | 'pending' | 'confirmed' | 'failed' | 'underpaid';\n\n/**\n * Supported chain configuration\n */\nexport interface ChainConfig {\n  chainId: number;\n  name: string;\n  rpcUrl: string;\n  symbol: string;\n  confirmations?: number;\n}\n\n/**\n * Price configuration\n */\nexport interface Price {\n  amount: string;\n  tokenSymbol: string;\n  chainId: number;\n}\n\n/**\n * Payment link entity\n */\nexport interface PayLink {\n  id: string;\n  targetUrl: string;\n  price: Price;\n  recipientAddress: string;\n  status: PayLinkStatus;\n  createdAt: Date;\n  updatedAt: Date;\n  description?: string;\n  maxUses?: number;\n  usedCount?: number;\n  expiresAt?: Date;\n  metadata?: Record<string, unknown>;\n}\n\n/**\n * Payment record\n */\nexport interface Payment {\n  id: string;\n  payLinkId: string;\n  chainId: number;\n  txHash: string;\n  fromAddress: string;\n  amount: string;\n  confirmed: boolean;\n  createdAt: Date;\n  confirmedAt?: Date;\n}\n\n/**\n * Input for creating a payment link\n */\nexport interface CreatePayLinkInput {\n  targetUrl: string;\n  price: Price;\n  recipientAddress: string;\n  description?: string;\n  maxUses?: number;\n  expiresAt?: Date;\n  metadata?: Record<string, unknown>;\n}\n\n/**\n * 402 Protocol response\n */\nexport interface Protocol402Response {\n  protocol: '402-paylink-v1';\n  payLinkId: string;\n  resource: {\n    description?: string;\n    preview?: string | null;\n  };\n  payment: {\n    chainId: number;\n    tokenSymbol: string;\n    amount: string;\n    recipient: string;\n    timeoutSeconds: number;\n  };\n  callbacks: {\n    status: string;\n    confirm: string;\n  };\n  nonce: string;\n  signature?: string;\n}\n\n/**\n * 403 Reason codes\n */\nexport enum ReasonCode {\n  LINK_NOT_FOUND = 'LINK_NOT_FOUND',\n  LINK_DISABLED = 'LINK_DISABLED',\n  LINK_EXPIRED = 'LINK_EXPIRED',\n  LINK_USAGE_LIMIT_REACHED = 'LINK_USAGE_LIMIT_REACHED',\n  PAYMENT_UNDERPAID = 'PAYMENT_UNDERPAID',\n  PAYMENT_CHAIN_NOT_SUPPORTED = 'PAYMENT_CHAIN_NOT_SUPPORTED',\n  ACCESS_DENIED = 'ACCESS_DENIED',\n  INTERNAL_ERROR = 'INTERNAL_ERROR',\n}\n\n/**\n * 403 Protocol response\n */\nexport interface Protocol403Response {\n  protocol: '403-paylink-v1';\n  payLinkId?: string;\n  reasonCode: ReasonCode;\n  reasonMessage: string;\n  details?: Record<string, unknown>;\n}\n\n/**\n * Server configuration\n */\nexport interface PaylinkConfig {\n  /** Server port */\n  port?: number;\n  /** Base URL for callbacks (e.g., https://your-domain.com) */\n  baseUrl?: string;\n  /** Base path for paylink routes (default: /pay) */\n  basePath?: string;\n  /** Supported blockchain networks */\n  chains: ChainConfig[];\n  /** Payment timeout in seconds (default: 900) */\n  paymentTimeout?: number;\n  /** Secret for signing responses */\n  signatureSecret?: string;\n  /** API key for admin endpoints */\n  apiKey?: string;\n  /** Enable CORS (default: true) */\n  cors?: boolean;\n}\n\n/**\n * Payment check result\n */\nexport interface PaymentCheckResult {\n  status: PaymentStatus;\n  actualAmount?: string;\n  fromAddress?: string;\n  raw?: unknown;\n}\n\n/**\n * Storage interface\n */\nexport interface Storage {\n  getPayLink(id: string): Promise<PayLink | null>;\n  savePayLink(payLink: PayLink): Promise<void>;\n  updatePayLink(payLink: PayLink): Promise<void>;\n  deletePayLink(id: string): Promise<void>;\n  getAllPayLinks(): Promise<PayLink[]>;\n  \n  savePayment(payment: Payment): Promise<void>;\n  getPaymentByTxHash(txHash: string): Promise<Payment | null>;\n  getConfirmedPayment(payLinkId: string): Promise<Payment | null>;\n  getAllPayments(): Promise<Payment[]>;\n}\n","import type { Storage, PayLink, Payment } from './types.js';\n\n/**\n * In-memory storage implementation\n * Replace with database for production\n */\nexport class MemoryStorage implements Storage {\n  private links = new Map<string, PayLink>();\n  private payments = new Map<string, Payment>();\n  private paymentsByTx = new Map<string, Payment>();\n  private paymentsByLink = new Map<string, Payment[]>();\n\n  async getPayLink(id: string): Promise<PayLink | null> {\n    return this.links.get(id) ?? null;\n  }\n\n  async savePayLink(payLink: PayLink): Promise<void> {\n    this.links.set(payLink.id, { ...payLink });\n  }\n\n  async updatePayLink(payLink: PayLink): Promise<void> {\n    if (!this.links.has(payLink.id)) {\n      throw new Error(`PayLink ${payLink.id} not found`);\n    }\n    this.links.set(payLink.id, { ...payLink, updatedAt: new Date() });\n  }\n\n  async deletePayLink(id: string): Promise<void> {\n    this.links.delete(id);\n  }\n\n  async getAllPayLinks(): Promise<PayLink[]> {\n    return Array.from(this.links.values());\n  }\n\n  async savePayment(payment: Payment): Promise<void> {\n    this.payments.set(payment.id, { ...payment });\n    this.paymentsByTx.set(payment.txHash, payment);\n    \n    const list = this.paymentsByLink.get(payment.payLinkId) ?? [];\n    list.push(payment);\n    this.paymentsByLink.set(payment.payLinkId, list);\n  }\n\n  async getPaymentByTxHash(txHash: string): Promise<Payment | null> {\n    return this.paymentsByTx.get(txHash) ?? null;\n  }\n\n  async getConfirmedPayment(payLinkId: string): Promise<Payment | null> {\n    const list = this.paymentsByLink.get(payLinkId) ?? [];\n    return list.find(p => p.confirmed) ?? null;\n  }\n\n  async getAllPayments(): Promise<Payment[]> {\n    return Array.from(this.payments.values());\n  }\n\n  /** Clear all data */\n  clear(): void {\n    this.links.clear();\n    this.payments.clear();\n    this.paymentsByTx.clear();\n    this.paymentsByLink.clear();\n  }\n}\n","import { randomBytes, createHmac, randomUUID } from 'crypto';\n\n/**\n * Generate short unique ID\n */\nexport function generateId(length = 8): string {\n  const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';\n  const bytes = randomBytes(length);\n  let result = '';\n  for (let i = 0; i < length; i++) {\n    result += chars[bytes[i] % chars.length];\n  }\n  return result;\n}\n\n/**\n * Generate UUID\n */\nexport function generateUUID(): string {\n  return randomUUID();\n}\n\n/**\n * Generate nonce\n */\nexport function generateNonce(): string {\n  return randomBytes(16).toString('hex');\n}\n\n/**\n * Create HMAC signature\n */\nexport function sign(data: string, secret: string): string {\n  return createHmac('sha256', secret).update(data).digest('hex');\n}\n\n/**\n * Check if date is expired\n */\nexport function isExpired(date?: Date): boolean {\n  if (!date) return false;\n  return new Date() > new Date(date);\n}\n\n/**\n * Check if usage limit reached\n */\nexport function isLimitReached(used?: number, max?: number): boolean {\n  if (max === undefined) return false;\n  return (used ?? 0) >= max;\n}\n\n/**\n * Compare amounts\n */\nexport function compareAmounts(a: string, b: string): number {\n  const numA = parseFloat(a);\n  const numB = parseFloat(b);\n  if (numA < numB) return -1;\n  if (numA > numB) return 1;\n  return 0;\n}\n\n/**\n * Reason code messages\n */\nexport const REASON_MESSAGES: Record<string, string> = {\n  LINK_NOT_FOUND: 'Payment link not found.',\n  LINK_DISABLED: 'This payment link has been disabled.',\n  LINK_EXPIRED: 'This payment link has expired.',\n  LINK_USAGE_LIMIT_REACHED: 'This payment link has reached its usage limit.',\n  PAYMENT_UNDERPAID: 'Payment amount is less than required.',\n  PAYMENT_CHAIN_NOT_SUPPORTED: 'This blockchain is not supported.',\n  ACCESS_DENIED: 'Access denied.',\n  INTERNAL_ERROR: 'An internal error occurred.',\n};\n","import type { ChainConfig, PaymentCheckResult } from './types.js';\nimport { compareAmounts } from './utils.js';\n\n/**\n * Blockchain payment verifier\n */\nexport class ChainVerifier {\n  private config: ChainConfig;\n  private requestId = 0;\n\n  constructor(config: ChainConfig) {\n    this.config = config;\n  }\n\n  get chainId(): number {\n    return this.config.chainId;\n  }\n\n  /**\n   * Verify payment on chain\n   */\n  async verifyPayment(params: {\n    txHash: string;\n    recipient: string;\n    amount: string;\n  }): Promise<PaymentCheckResult> {\n    try {\n      // Get transaction\n      const tx = await this.rpc('eth_getTransactionByHash', [params.txHash]);\n      \n      if (!tx) {\n        return { status: 'not_found' };\n      }\n\n      // Not mined yet\n      if (!tx.blockNumber) {\n        return { status: 'pending' };\n      }\n\n      // Get receipt\n      const receipt = await this.rpc('eth_getTransactionReceipt', [params.txHash]);\n      \n      if (!receipt) {\n        return { status: 'pending' };\n      }\n\n      // Failed transaction\n      if (receipt.status === '0x0') {\n        return { status: 'failed' };\n      }\n\n      // Check confirmations\n      const currentBlock = await this.rpc('eth_blockNumber', []);\n      const txBlock = parseInt(tx.blockNumber, 16);\n      const current = parseInt(currentBlock, 16);\n      const confirmations = current - txBlock;\n\n      if (confirmations < (this.config.confirmations ?? 1)) {\n        return { status: 'pending' };\n      }\n\n      // Verify recipient\n      const recipientLower = params.recipient.toLowerCase();\n      const toAddress = (tx.to || '').toLowerCase();\n      \n      if (toAddress !== recipientLower) {\n        // Check if it's a token transfer\n        if (!this.isTokenTransfer(receipt, recipientLower)) {\n          return { status: 'not_found' };\n        }\n      }\n\n      // Calculate amount\n      const valueWei = BigInt(tx.value || '0');\n      const actualAmount = this.weiToEther(valueWei);\n\n      // Check amount\n      if (compareAmounts(actualAmount, params.amount) < 0) {\n        return {\n          status: 'underpaid',\n          actualAmount,\n          fromAddress: tx.from,\n        };\n      }\n\n      return {\n        status: 'confirmed',\n        actualAmount,\n        fromAddress: tx.from,\n        raw: { tx, receipt },\n      };\n    } catch (error) {\n      console.error(`Chain ${this.config.chainId} verification error:`, error);\n      return { status: 'not_found' };\n    }\n  }\n\n  private async rpc(method: string, params: unknown[]): Promise<any> {\n    const controller = new AbortController();\n    const timeout = setTimeout(() => controller.abort(), 30000);\n\n    try {\n      const response = await fetch(this.config.rpcUrl, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          jsonrpc: '2.0',\n          id: ++this.requestId,\n          method,\n          params,\n        }),\n        signal: controller.signal,\n      });\n\n      const data = await response.json() as { error?: { message: string }; result?: unknown };\n      \n      if (data.error) {\n        throw new Error(data.error.message);\n      }\n      \n      return data.result;\n    } finally {\n      clearTimeout(timeout);\n    }\n  }\n\n  private isTokenTransfer(receipt: any, recipient: string): boolean {\n    // ERC20 Transfer event signature\n    const transferTopic = '0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef';\n    \n    for (const log of receipt.logs || []) {\n      if (log.topics?.[0] === transferTopic && log.topics.length >= 3) {\n        const to = '0x' + log.topics[2].slice(26).toLowerCase();\n        if (to === recipient) {\n          return true;\n        }\n      }\n    }\n    \n    return false;\n  }\n\n  private weiToEther(wei: bigint): string {\n    return (Number(wei) / 1e18).toString();\n  }\n}\n\n/**\n * Mock verifier for development/testing\n */\nexport class MockVerifier {\n  private confirmed = new Set<string>();\n  private pending = new Set<string>();\n  private failed = new Set<string>();\n\n  chainId = 1;\n\n  markConfirmed(txHash: string): void {\n    this.confirmed.add(txHash);\n    this.pending.delete(txHash);\n    this.failed.delete(txHash);\n  }\n\n  markPending(txHash: string): void {\n    this.pending.add(txHash);\n  }\n\n  markFailed(txHash: string): void {\n    this.failed.add(txHash);\n  }\n\n  async verifyPayment(params: {\n    txHash: string;\n    recipient: string;\n    amount: string;\n  }): Promise<PaymentCheckResult> {\n    await new Promise(r => setTimeout(r, 100));\n\n    if (this.failed.has(params.txHash)) {\n      return { status: 'failed' };\n    }\n\n    if (this.pending.has(params.txHash)) {\n      return { status: 'pending' };\n    }\n\n    // Auto-confirm for testing\n    return {\n      status: 'confirmed',\n      actualAmount: params.amount,\n      fromAddress: '0x' + 'a'.repeat(40),\n    };\n  }\n}\n"],"mappings":"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","names":["ReasonCode"]}